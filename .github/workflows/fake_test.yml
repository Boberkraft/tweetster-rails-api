name: Run Fake test

on:
  repository_dispatch:
    types: [on-demand-test]

jobs:
  run-tests:
    name: OK
    runs-on: ubuntu-latest
    env:
      REPOSITORY_NAME: ${{ github.event.client_payload.repository_name }}
      BRANCH_NAME: ${{ github.event.client_payload.branch_name }}

    steps:
      - name: works
        run: |
          echo "Running test"
          echo "branch_name: ${{ github.event.client_payload.branch_name }}"
          echo "repository_name: ${{ github.event.client_payload.repository_name }}"
          echo "comment_repository_name: ${{ github.event.client_payload.comment_repository_name }}"
          echo "comment_id: ${{ github.event.client_payload.comment_id }}"
      - name: Create URL to the run output
        id: vars
        run: echo ::set-output name=run-url::https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
      - name: Update comment
        uses: peter-evans/create-or-update-comment@v1
        with:
          token: ${{ secrets.TOKEN }}
          repository: ${{ github.event.client_payload.comment_repository_name }}
          comment-id: ${{ github.event.client_payload.comment_id }}
          body: |
            > ${{ github.event.client_payload.repository_name }}: ${{ steps.vars.outputs.run-url }}


      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.3.3
          bundler-cache: true

      - uses: mirromutth/mysql-action@v1.1
        with:
          host port: 3800 # Optional, default value is 3306. The port of host
          container port: 3307 # Optional, default value is 3306. The port of container
          character set server: 'utf8' # Optional, default value is 'utf8mb4'. The '--character-set-server' option for mysqld
          collation server: 'utf8_general_ci' # Optional, default value is 'utf8mb4_general_ci'. The '--collation-server' option for mysqld
          mysql version: '5.5.62' # Optional, default value is "latest". The version of the MySQL
          mysql database: 'some_test' # Optional, default value is "test". The specified database which will be create
          mysql root password: ${{ secrets.RootPassword }} # Required if "mysql user" is empty, default is empty. The root superuser password
          mysql user: 'root' # Required if "mysql root password" is empty, default is empty. The superuser for the specified database. Can use secrets, too
          mysql password: 'admin'

      - name: Installing tree
        run: sudo apt-get install tree


      - name: Checkout tweetster-rails-api repo
        uses: actions/checkout@v2
        with:
          repository: Boberkraft/tweetster-rails-api
          path: tweetster-rails-api

      - name: Checkout chess repo
        uses: actions/checkout@v2
        with:
          repository: Boberkraft/chess
          path: chess

      - name: Checkout Rails-4-Twitter-Clone
        uses: actions/checkout@v2
        with:
          repository: Boberkraft/Rails-4-Twitter-Clone
          path: Rails-4-Twitter-Clone



      - name: Change branches
        env:
          BRANCH_NAME: master
          GITHUB_WORKSPACE: ${{ env.GITHUB_WORKSPACE }}
          MY_PATH: ${{ env.GITHUB_WORKSPACE }}
          AAAAAAA: eeeeeeeee
        run: |
          chmod 777 $GITHUB_WORKSPACE/tweetster-rails-api/lib/scripts/change_branches.rb
          ruby $GITHUB_WORKSPACE/tweetster-rails-api/lib/scripts/change_branches.rb
          cd $GITHUB_WORKSPACE/${{ env.REPOSITORY_NAME }}

      - name: Bundler Install
        working-directory: ${{ env.REPOSITORY_NAME }}
        run: |
          gem install bundler
          bundle install --jobs 4 --retry 3
          mv db/cli-schema.rb db/schema.rb
          bundle exec rake db:schema:load
          bundle exec rake db:migrate RAILS_ENV=development

      - name: Testing master...
        working-directory: ${{ env.REPOSITORY_NAME }}
        run: bundle exec rspec
