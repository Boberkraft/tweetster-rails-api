name: Run Fake test

on:
  repository_dispatch:
    types: [on-demand-test]

jobs:
  run-tests:
    name: OK
    runs-on: ubuntu-latest
    env:
      REPOSITORY_NAME: ${{ github.event.client_payload.repository_name }}
      BRANCH_NAME: ${{ github.event.client_payload.branch_name }}

    services:
      mysql:
        image: mysql:5.5
        ports:
          - 3306
        env:
          MYSQL_DATABASE: super-db-test
          MYSQL_ROOT_PASSWORD: admin
        options: --health-cmd="mysqladmin ping" --health-interval=20s --health-timeout=5s --health-retries=7

    steps:
      - name: DEBUG INFO
        run: |
          echo "Running test"
          echo "branch_name: ${{ github.event.client_payload.branch_name }}"
          echo "repository_name: ${{ github.event.client_payload.repository_name }}"
          echo "comment_repository_name: ${{ github.event.client_payload.comment_repository_name }}"
          echo "comment_id: ${{ github.event.client_payload.comment_id }}"
      - name: Create URL to the run output
        id: vars
        run: echo ::set-output name=run-url::https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
      - name: Update comment
        uses: peter-evans/create-or-update-comment@v1
        with:
          token: ${{ secrets.TOKEN }}
          repository: ${{ github.event.client_payload.comment_repository_name }}
          comment-id: ${{ github.event.client_payload.comment_id }}
          body: |
            > ${{ github.event.client_payload.repository_name }}: ğŸ’ƒğŸ•º ${{ steps.vars.outputs.run-url }}

      - name: Starting MySQL
        run: sudo service mysql start

      - name: DEBUG testing if db works
        run: |
          export MYSQL_HOST=127.0.0.1
          export MYSQL_TCP_PORT=${{ job.services.mysql.ports['3306'] }}
          mysql -e 'CREATE DATABASE IF NOT EXISTS wp_cli_test;' -uroot -padmin

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.3.3

      - name: Create hash key
        id: hash_key
        run: |
          echo ::set-output name=key::$RUNNER_WORKSPACE/$REPOSITORY_NAME/Gemfile.lock

      - run: |
          echo $XD
          cat $XD
        env:
          XD: ${{ steps.hash_key.outputs.key }}


      - name: Installing libs
        run: |
          sudo apt-get install tree
          sudo apt-get install libmariadbclient-dev


      - name: Checkout tweetster-rails-api repo
        uses: actions/checkout@v2
        with:
          repository: Boberkraft/tweetster-rails-api
          path: tweetster-rails-api

      - name: Checkout chess repo
        uses: actions/checkout@v2
        with:
          repository: Boberkraft/chess
          path: chess

      - name: Checkout Rails-4-Twitter-Clone
        uses: actions/checkout@v2
        with:
          repository: Boberkraft/Rails-4-Twitter-Clone
          path: Rails-4-Twitter-Clone
          
      - name: Setup cache key and directory for gems cache
        uses: actions/cache@v2
        with:
          path: ${{ env.GITHUB_WORKSPACE }}/vendor/bundle
          key: ${{ runner.os }}-gem-${{ env.REPOSITORY_NAME }}-${{ hashFiles(steps.hash_key.outputs.key) }}
          restore-keys: |
            ${{ runner.os }}-gem-${{ env.REPOSITORY_NAME }}-
            ${{ runner.os }}-gem-
            ${{ runner.os }}-

      - name: Change branches on all repos
        env:
          BRANCH_NAME: master
          GITHUB_WORKSPACE: ${{ env.GITHUB_WORKSPACE }}
          MY_PATH: ${{ env.GITHUB_WORKSPACE }}
        run: |
          chmod 777 $GITHUB_WORKSPACE/tweetster-rails-api/lib/scripts/change_branches.rb
          ruby $GITHUB_WORKSPACE/tweetster-rails-api/lib/scripts/change_branches.rb

      - name: Bundler Install
        working-directory: ${{ env.REPOSITORY_NAME }}
        run: |
          gem install bundler --version=1.13  --no-ri --no-rdoc
          bundle config path $GITHUB_WORKSPACE/vendor/bundle

          bundle --jobs 4 --retry 3


          ruby $GITHUB_WORKSPACE/tweetster-rails-api/lib/scripts/prepare_schema.rb
          mv config/database.yml-ci config/database.yml

          bundle exec rake db:create RAILS_ENV=test
          bundle exec rake db:schema:load RAILS_ENV=test
          bundle exec rake db:migrate RAILS_ENV=test
        env:
          DB_PORT: ${{ job.services.mysql.ports['3306'] }}

      - name: Testing master...
        working-directory: ${{ env.REPOSITORY_NAME }}
        run: bundle exec rspec
        env:
          DB_PORT: ${{ job.services.mysql.ports['3306'] }}

      - name: HAPPY PUDZIAN
        uses: peter-evans/create-or-update-comment@v1
        if: success()
        with:
          token: ${{ secrets.TOKEN }}
          repository: ${{ github.event.client_payload.comment_repository_name }}
          comment-id: ${{ github.event.client_payload.comment_id }}
          body: |
            > ${{ github.event.client_payload.repository_name }}: ğŸ’ªğŸ™‚

      - name: SAD PUDZIAN
        uses: peter-evans/create-or-update-comment@v1
        if: failure()
        with:
          token: ${{ secrets.TOKEN }}
          repository: ${{ github.event.client_payload.comment_repository_name }}
          comment-id: ${{ github.event.client_payload.comment_id }}
          body: |
            > ${{ github.event.client_payload.repository_name }}: ğŸ˜­ğŸ’”